import { useState } from 'react';
import { useTranslation } from 'react-i18next';
import axios from 'axios';
import { 
  Chart, 
  AlgorithmHeader, 
  InteractiveExperiment,
  ExperimentPanel,
  ParameterControl,
  ResultCard
} from '@common/modules/MDX/MDXComponents';
import { DatasetInfo, DatasetPreview, useDataset } from '@modules/Datasets';
import { useLogger } from '@common/modules/Logger';
import { useExceptions, ExceptionType, ExceptionSeverity } from '@common/modules/Exceptions';
import { Database, Settings, TrendingUp } from 'lucide-react';

export const LinearRegressionDemo = () => {
  const { t } = useTranslation();
  const logger = useLogger();
  const { captureException } = useExceptions();
  
  // 固定使用加州房价数据集
  const FIXED_DATASET = 'california_housing';
  
  const [learningRate, setLearningRate] = useState(0.01);
  const [iterations, setIterations] = useState(1000);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  
  // 使用 Datasets 模块加载数据集
  const { dataset, loading: loadingDataset, error: datasetError } = useDataset(FIXED_DATASET);

  const runTraining = async () => {
    setLoading(true);
    logger.info('开始训练线性回归模型', { dataset: FIXED_DATASET, learningRate, iterations });
    
    try {
      const response = await axios.post('/api/algorithms/supervised/linear-regression/train', {
        dataset: FIXED_DATASET,
        learning_rate: learningRate,
        iterations: iterations,
      });
      setResult(response.data);
      logger.info('线性回归模型训练成功', { result: response.data });
    } catch (error) {
      logger.error('线性回归模型训练失败', { error: error.message, dataset: FIXED_DATASET, learningRate, iterations });
      captureException(error, {
        type: ExceptionType.NETWORK,
        severity: ExceptionSeverity.HIGH,
        context: { 
          algorithm: 'linear-regression',
          dataset: FIXED_DATASET,
          learningRate,
          iterations,
          message: '训练失败，请检查后端服务是否正常运行'
        }
      });
    } finally {
      setLoading(false);
    }
  };

  const resetParameters = () => {
    setLearningRate(0.01);
    setIterations(1000);
    setResult(null);
  };

  return (
    <InteractiveExperiment
      description="通过调整参数，观察线性回归模型的训练过程和拟合效果"
      onRun={runTraining}
      onReset={resetParameters}
      loading={loading}
      result={result && (
        <>
          <ResultCard title="📈 训练结果" variant="success" className="mb-4">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-white p-3 rounded-lg border">
                <div className="text-sm text-gray-600">模型系数 (w)</div>
                <div className="text-lg font-semibold">{result.coefficients?.toFixed(4)}</div>
              </div>
              <div className="bg-white p-3 rounded-lg border">
                <div className="text-sm text-gray-600">截距 (b)</div>
                <div className="text-lg font-semibold">{result.intercept?.toFixed(4)}</div>
              </div>
              <div className="bg-white p-3 rounded-lg border">
                <div className="text-sm text-gray-600">R² Score</div>
                <div className="text-lg font-semibold">{result.r2_score?.toFixed(4)}</div>
              </div>
              <div className="bg-white p-3 rounded-lg border">
                <div className="text-sm text-gray-600">MSE</div>
                <div className="text-lg font-semibold">{result.mse?.toFixed(4)}</div>
              </div>
            </div>
          </ResultCard>

          {result.plot_data && (
            <ResultCard title="📊 拟合可视化" variant="info">
              <Chart
                data={result.plot_data}
                layout={{
                  title: '线性回归拟合结果',
                  xaxis: { title: 'X' },
                  yaxis: { title: 'Y' },
                  height: 400,
                }}
              />
            </ResultCard>
          )}
        </>
      )}
    >
      {/* 数据集与特征说明 */}
      <ExperimentPanel icon={Database}>
        <DatasetInfo datasetName={FIXED_DATASET} />
        
        {datasetError && (
          <div className="mt-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-red-700 dark:text-red-300 text-sm">
            ⚠️ {datasetError}
          </div>
        )}
        
        {/* 特征说明 */}
        <div className="mt-4 space-y-4 text-sm">
          <div>
            <div className="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2">
              <span className="text-lg">🎯</span>
              预测目标
            </div>
            <div className="ml-6 space-y-1 text-gray-700 dark:text-gray-300">
              <div className="flex items-center gap-2">
                <span className="font-mono bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-200 px-2 py-1 rounded text-xs font-medium">MEDV</span>
                <span>- 房屋价格中位数（单位：十万美元）</span>
              </div>
            </div>
          </div>
          
          <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
            <div className="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2">
              <span className="text-lg">📊</span>
              输入特征
            </div>
            <div className="ml-6 grid grid-cols-1 sm:grid-cols-2 gap-2 text-gray-700 dark:text-gray-300">
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">MedInc</span>
                <span>- 街区收入中位数</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">HouseAge</span>
                <span>- 房屋年龄中位数</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">AveRooms</span>
                <span>- 平均房间数</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">AveBedrms</span>
                <span>- 平均卧室数</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">Population</span>
                <span>- 街区人口数</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">AveOccup</span>
                <span>- 平均入住率</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">Latitude</span>
                <span>- 纬度</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs font-medium">Longitude</span>
                <span>- 经度</span>
              </div>
            </div>
          </div>
          
          <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
            <div className="font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2">
              <span className="text-lg">💡</span>
              实验目标
            </div>
            <div className="ml-6 text-gray-700 dark:text-gray-300">
              使用 <strong className="text-gray-900 dark:text-gray-100">8 个特征</strong> 预测加州地区房屋价格，探索特征与房价之间的线性关系
            </div>
          </div>
        </div>
        
        <DatasetPreview datasetName={FIXED_DATASET} maxRows={5} className="mt-4" />
      </ExperimentPanel>

      {/* 参数调整面板 */}
      <ExperimentPanel title="🎛️ 参数调整" icon={Settings}>
        {/* 预设配置按钮 */}
        <div className="mb-6">
          <div className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">快速配置</div>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => {
                setLearningRate(0.01);
                setIterations(1000);
                setTimeout(() => runTraining(), 100);
              }}
              className="px-3 py-2 bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 rounded-lg text-sm font-medium hover:bg-blue-200 dark:hover:bg-blue-900/60 transition-colors"
            >
              🚀 快速开始 (推荐)
            </button>
            <button
              onClick={() => {
                setLearningRate(0.005);
                setIterations(2000);
                setTimeout(() => runTraining(), 100);
              }}
              className="px-3 py-2 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 rounded-lg text-sm font-medium hover:bg-green-200 dark:hover:bg-green-900/60 transition-colors"
            >
              🎯 精确训练
            </button>
            <button
              onClick={() => {
                setLearningRate(0.02);
                setIterations(500);
                setTimeout(() => runTraining(), 100);
              }}
              className="px-3 py-2 bg-orange-100 dark:bg-orange-900/40 text-orange-800 dark:text-orange-200 rounded-lg text-sm font-medium hover:bg-orange-200 dark:hover:bg-orange-900/60 transition-colors"
            >
              ⚡ 快速训练
            </button>
          </div>
        </div>

        {/* 参数解释 */}
        <div className="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
          <div className="text-sm font-medium text-blue-900 dark:text-blue-100 mb-3">💡 参数含义解释</div>
          <div className="space-y-3 text-sm text-blue-800 dark:text-blue-200">
            <div>
              <span className="font-semibold">学习率</span>：想象成"调整的幅度"
              <div className="mt-1 pl-3 text-xs">
                • 太大 → 像用力过猛，可能越调越偏 🏃‍♂️💨<br/>
                • 太小 → 像小碎步，调整速度很慢 🐢<br/>
                • 刚好 → 稳定又高效 ✨
              </div>
            </div>
            <div>
              <span className="font-semibold">迭代次数</span>：想象成"练习的次数"
              <div className="mt-1 pl-3 text-xs">
                • 太少 → 还没学会就停了 📝<br/>
                • 太多 → 过度练习，死记硬背 📚<br/>
                • 刚好 → 充分学习，举一反三 🎯
              </div>
            </div>
          </div>
        </div>

        {/* 手动调整 */}
        <div className="space-y-4">
          <div className="text-sm font-medium text-gray-700 dark:text-gray-300">手动调整</div>
          
          <ParameterControl
            label="学习率 (每次调整的幅度)"
            description="数值越大，每次调整越大；数值越小，每次调整越小"
            value={learningRate}
            onChange={(value) => {
              setLearningRate(value);
              // 参数变化时自动运行
              setTimeout(() => runTraining(), 300);
            }}
            min={0.001}
            max={0.1}
            step={0.001}
            recommendedValue={0.01}
            recommendedReason="0.01 是一个稳定又高效的值，适合初学者"
          />
          
          <ParameterControl
            label="迭代次数 (练习多少次)"
            description="模型会练习这么多次来学会预测规律"
            value={iterations}
            onChange={(value) => {
              setIterations(value);
              // 参数变化时自动运行
              setTimeout(() => runTraining(), 300);
            }}
            min={100}
            max={5000}
            step={100}
            recommendedValue={1000}
            recommendedReason="1000 次通常足够学会规律，又不会过度练习"
          />
        </div>
      </ExperimentPanel>
    </InteractiveExperiment>
  );
};

<AlgorithmHeader 
  title="线性回归 Linear Regression"
  difficulty="beginner"
  stars={2}
  time={15}
/>

## 1️⃣ 算法概览

**线性回归**（Linear Regression）是机器学习中最基础、最重要的监督学习算法之一。它通过拟合一条直线（或高维空间中的超平面）来建模自变量 X 和因变量 Y 之间的线性关系。

### 核心思想

- 假设目标值与特征之间存在**线性关系**
- 通过最小化预测值与真实值之间的**误差平方和**来找到最优拟合直线
- 使用**梯度下降法**或**正规方程**求解最优参数

### 应用场景

- 📈 **房价预测**：根据面积、位置等特征预测房价
- 💰 **销售预测**：根据历史数据预测未来销售额
- 📊 **趋势分析**：分析变量之间的相关性和趋势
- 🌡️ **温度预测**：根据历史气温数据预测未来温度

---

## 2️⃣ 发展历史

线性回归的历史可以追溯到19世纪初：

- **1805年** - 法国数学家**勒让德**（Adrien-Marie Legendre）首次提出**最小二乘法**
- **1809年** - 德国数学家**高斯**（Carl Friedrich Gauss）独立发现并系统化了最小二乘法
- **1886年** - 英国统计学家**弗朗西斯·高尔顿**（Francis Galton）研究父子身高关系时，首次使用"回归"（Regression）一词
- **20世纪** - 随着计算机的发展，线性回归成为统计学和机器学习的基石

---

## 3️⃣ 数学原理

### 模型表示

对于单变量线性回归，模型可以表示为：

```math
y = wx + b
```

对于多变量线性回归：

```math
y = w_1x_1 + w_2x_2 + ... + w_nx_n + b = \mathbf{w}^T\mathbf{x} + b
```

其中：
- $y$ 是预测值
- $\mathbf{x}$ 是特征向量
- $\mathbf{w}$ 是权重向量
- $b$ 是偏置项（截距）

### 损失函数

使用**均方误差**（Mean Squared Error, MSE）作为损失函数：

```math
J(\mathbf{w}, b) = \frac{1}{2m}\sum_{i=1}^{m}(h_{\mathbf{w},b}(\mathbf{x}^{(i)}) - y^{(i)})^2
```

### 梯度下降

通过梯度下降法更新参数：

```math
w_j := w_j - \alpha \frac{\partial J}{\partial w_j}
```

```math
b := b - \alpha \frac{\partial J}{\partial b}
```

其中 $\alpha$ 是学习率。

---

## 4️⃣ 交互式实验 ⚡

<LinearRegressionDemo />

---

## 5️⃣ 代码实现

### Python 实现（使用 scikit-learn）

```python
import numpy as np
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error, r2_score

# 生成示例数据
X = np.random.rand(100, 1) * 10
y = 2.5 * X + 1.5 + np.random.randn(100, 1) * 2

# 划分训练集和测试集
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# 创建并训练模型
model = LinearRegression()
model.fit(X_train, y_train)

# 预测
y_pred = model.predict(X_test)

# 评估
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)

print(f"系数: {model.coef_[0][0]:.4f}")
print(f"截距: {model.intercept_[0]:.4f}")
print(f"MSE: {mse:.4f}")
print(f"R² Score: {r2:.4f}")
```

### 从零实现梯度下降

```python
def linear_regression_gradient_descent(X, y, learning_rate=0.01, iterations=1000):
    m, n = X.shape
    w = np.zeros((n, 1))
    b = 0
    
    for i in range(iterations):
        # 预测
        y_pred = X @ w + b
        
        # 计算梯度
        dw = (1/m) * X.T @ (y_pred - y)
        db = (1/m) * np.sum(y_pred - y)
        
        # 更新参数
        w -= learning_rate * dw
        b -= learning_rate * db
    
    return w, b
```

---

## 6️⃣ 优缺点分析

### ✅ 优点

- **简单易懂**：模型结构简单，易于理解和实现
- **计算高效**：训练和预测速度快，适合大规模数据
- **可解释性强**：系数直接反映特征对目标的影响程度
- **鲁棒性好**：对异常值敏感度相对较低（相比决策树）

### ❌ 缺点

- **线性假设**：只能拟合线性关系，无法处理复杂的非线性模式
- **特征工程依赖**：需要手动构造特征来捕捉非线性关系
- **多重共线性**：特征之间高度相关时，模型不稳定
- **异常值敏感**：极端值会显著影响拟合结果

---

## 7️⃣ 实际应用案例

### 案例1：波士顿房价预测

使用房屋面积、房间数量、犯罪率等13个特征预测房价：

```python
from sklearn.datasets import load_boston
from sklearn.preprocessing import StandardScaler

# 加载数据
boston = load_boston()
X, y = boston.data, boston.target

# 标准化特征
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

# 训练模型
model = LinearRegression()
model.fit(X_scaled, y)

# 特征重要性分析
feature_importance = pd.DataFrame({
    'feature': boston.feature_names,
    'coefficient': model.coef_
}).sort_values('coefficient', key=abs, ascending=False)
```

### 案例2：广告投入与销售额

分析电视、广播、报纸广告投入对销售额的影响：

```python
# 多元线性回归
# y = w1*TV + w2*Radio + w3*Newspaper + b

model = LinearRegression()
model.fit(advertising_data[['TV', 'Radio', 'Newspaper']], 
          advertising_data['Sales'])

print(f"TV系数: {model.coef_[0]:.4f}")
print(f"Radio系数: {model.coef_[1]:.4f}")
print(f"Newspaper系数: {model.coef_[2]:.4f}")
```

---

## 8️⃣ 扩展阅读

- **Ridge回归（岭回归）**：添加 L2 正则化，防止过拟合
- **Lasso回归**：添加 L1 正则化，实现特征选择
- **多项式回归**：通过多项式特征扩展捕捉非线性关系
- **局部加权回归**：对不同区域赋予不同权重

---

## 🎯 关键要点

1. 线性回归假设特征与目标之间存在**线性关系**
2. 通过**最小二乘法**或**梯度下降法**求解最优参数
3. **学习率**和**迭代次数**是影响训练效果的重要超参数
4. 模型简单高效，但只适用于线性或近似线性的问题
5. 可以通过**特征工程**和**正则化**提升模型性能

